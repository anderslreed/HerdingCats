@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

@using Radzen
@using Radzen.Blazor

@typeparam TItem where TItem : new()

<RadzenCard>
    <RadzenDataGrid @ref=_grid id=@_gridId TItem=@TItem Data=@Data CellDoubleClick=@OnCellDoubleClick
        SelectionMode=@DataGridSelectionMode.Single @bind-Value=@SelectedList>
        <Columns>
            @Columns
        </Columns>
    </RadzenDataGrid>
    <RadzenButton id=@_addButtonId Click=OnAddButtonClick aria-label=@_addButtonAria />
    <RadzenButton id=@_removeButtonId Click=OnDeleteButtonClick Disabled=@(_selectedItem is null)
        aria-label=@_removeButtonAria />
</RadzenCard>

@code {
    [Parameter]
    public RenderFragment Columns { get; set; } = builder => { };

    [Parameter]
    public string? ComponentName { get; set; }

    [Parameter]
    public ICollection<TItem> Data { get; set; } = [];

    [Parameter]
    public Func<TItem> ItemFactory { get; set; } = () => new();

    [Parameter]
    public string ItemName { get; set; } = typeof(TItem).Name;

    public TItem? SelectedItem => _selectedItem;

    private IList<TItem> SelectedList
    {
        get => _selectedItem is null ? [] : [_selectedItem];
        set
        {
            TItem? nextSelection = value.FirstOrDefault();
            if (_selectedItem is not null && !_selectedItem.Equals(nextSelection))
            {
                _grid!.CancelEditRow(_selectedItem);
            }
            _selectedItem = nextSelection;
        }
    }

    private TItem? _selectedItem;
    private RadzenDataGrid<TItem>? _grid;

    private string? _gridId;
    private string? _addButtonId;
    private string? _addButtonAria;
    private string? _removeButtonId;
    private string? _removeButtonAria;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        _gridId = (ComponentName ?? $"grid_{ItemName}").ToLower();
        _addButtonId = $"{_gridId}_btn_add";
        _addButtonAria = $"Add new {ItemName}";
        _removeButtonId = $"{_gridId}_btn_rm";
        _removeButtonAria = $"Remove selected {ItemName}";
    }

    private void OnCellDoubleClick(DataGridCellMouseEventArgs<TItem> args)
    {
        SelectedList = [args.Data];
        _grid!.EditRow(args.Data);
    }

    private async void OnAddButtonClick()
    {
        if (ItemFactory is not null)
        {
            TItem item = ItemFactory();
            Data.Add(item);
            SelectedList = [item];
            await _grid!.RefreshDataAsync();
            await _grid!.EditRow(item);
        }
    }

    private async void OnDeleteButtonClick()
    {
        if (_selectedItem is not null)
        {
            Data.Remove(_selectedItem);
            await _grid!.RefreshDataAsync();
            _selectedItem = default;
        }
    }
}