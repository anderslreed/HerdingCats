@using HerdingCats.Data
@using HerdingCats.Data.Model

@inject IClientInfo clientInfo

@inherits FormBase<Cat>

<RadzenCard>
    <RadzenRow>
        <RadzenColumn>
            <RadzenStack Orientation=Orientation.Vertical>
                <RadzenLabel Component="txt_new_cat_name" Text="Name" />
                <RadzenTextBox Name="txt_new_cat_name" @bind-Value=addingItem.Name />
            </RadzenStack>
            <RadzenStack Orientation=Orientation.Vertical>
                <RadzenLabel Component="date_new_cat_intake" Text="Date of Intake" />
                <RadzenDatePicker TValue=DateOnly Name="date_new_cat_intake" @bind-Value=addingItem.IntakeDate />
            </RadzenStack>
            <RadzenLabel Text="Age at intake" />
            <RadzenStack Orientation=Orientation.Horizontal>
                <RadzenStack Orientation=Orientation.Vertical>
                    <RadzenLabel Component="num_new_cat_age_years" Text="Years" />
                    <RadzenNumeric TValue=short Name="num_new_cat_age_years" @bind-Value=_ageYears />
                </RadzenStack>
                <RadzenStack Orientation=Orientation.Vertical>
                    <RadzenLabel Component="num_new_cat_age_months" Text="Months" />
                    <RadzenNumeric TValue=short Name="num_new_cat_age_months" @bind-Value=_ageMonths />
                </RadzenStack>
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn>
            <RadzenStack Orientation=Orientation.Vertical>
                <RadzenLabel Component="txt_new_cat_comments" Text="Comments" />
                <RadzenTextArea Name="txt_new_cat_comments" @bind-Value=addingItem.IntakeComments />
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
    <RadzenRow>
        <RadzenButton id="btn_add_new_cat" Text="Add cat" Click=AddNewCat aria-label="Add cat" />
    </RadzenRow>
</RadzenCard>

@code {
    private short _ageYears = 1;
    private short _ageMonths;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            await InitIntakeDate();
            StateHasChanged();
        }
    }

    private async Task AddNewCat()
    {
        addingItem.BirthDate = addingItem.IntakeDate.AddYears(-_ageYears).AddMonths(-_ageMonths);
        await AddNew();
        await InitIntakeDate();
    }

    private async Task InitIntakeDate()
    {
        DateTime clientDateTime = await clientInfo.DateTime();
        addingItem.IntakeDate = DateOnly.FromDateTime(clientDateTime);
    }
}